# 🗄️ Database with Prisma & PostgreSQL

Complete database setup using Prisma ORM with PostgreSQL, featuring multi-schema architecture, migrations, and type-safe queries.

## Overview

This project uses **Prisma 6** as the ORM and **PostgreSQL 16** as the database. The schema is organized into multiple files for better maintainability.

## Features

✅ Multi-schema architecture (auth, todo, file)  
✅ Automatic TypeScript type generation  
✅ Migration management  
✅ Database seeding  
✅ Prisma Studio for visual management  
✅ Connection pooling  
✅ Transaction support  
✅ Full-text search ready  

## Configuration

### Environment Variables

```env
# Database
POSTGRES_DB=my_app_db
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_secure_password
DATABASE_URL=postgresql://postgres:your_secure_password@localhost:5432/my_app_db?sslmode=disable
```

### Prisma Configuration

Located in `prisma.config.ts`:

```typescript
import { defineConfig } from '@prisma/client/generator-helper';

export default defineConfig({
  generator: {
    provider: 'prisma-client',
    output: './src/prisma/generated',
    moduleFormat: 'esm',
  },
  datasource: {
    provider: 'postgresql',
    url: process.env.DATABASE_URL,
  },
});
```

## Schema Organization

### Main Schema (`src/prisma/schema/schema.prisma`)

```prisma
generator client {
    provider     = "prisma-client"
    output       = "../generated"
    moduleFormat = "esm"
}

datasource db {
    provider = "postgres"
    url      = env("DATABASE_URL")
}
```

### Auth Schema (`src/prisma/schema/auth.prisma`)

Auto-generated by Better Auth. Contains:
- **user** - User accounts
- **session** - Active sessions
- **account** - OAuth provider accounts
- **verification** - Email verification tokens

### Todo Schema (`src/prisma/schema/todo.prisma`)

```prisma
model Todo {
  id        String   @id @default(cuid())
  title     String
  completed Boolean  @default(false)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("todos")
}
```

### File Schema (`src/prisma/schema/file.prisma`)

```prisma
model File {
  id           String   @id @default(cuid())
  name         String
  originalName String
  mimeType     String
  size         Int
  path         String
  url          String
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@map("files")
}
```

## Available Scripts

```bash
# Generate Prisma Client
bun run db:generate

# Create and apply migration
bun run db:migrate

# Push schema changes (dev only, skips migrations)
bun run db:push

# Reset database (⚠️ deletes all data)
bun run db:reset

# Open Prisma Studio
bun run db:studio

# Full initialization (reset + generate + migrate)
bun run db:init

# Generate Better Auth schema
bun run auth:generate
```

## Usage

### Prisma Client Instance

Located in `src/prisma/index.ts`:

```typescript
import { PrismaClient } from './generated/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({
    log: process.env.NODE_ENV === 'development' ? ['error', 'warn'] : ['error'],
  });

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma;
}
```

### Basic Queries

```typescript
import { prisma } from '@/prisma';

// Create
const user = await prisma.user.create({
  data: {
    email: 'user@example.com',
    name: 'John Doe',
  },
});

// Find unique
const user = await prisma.user.findUnique({
  where: { email: 'user@example.com' },
});

// Find many with filtering
const todos = await prisma.todo.findMany({
  where: {
    userId: 'user-id',
    completed: false,
  },
  orderBy: {
    createdAt: 'desc',
  },
});

// Update
const todo = await prisma.todo.update({
  where: { id: 'todo-id' },
  data: { completed: true },
});

// Delete
await prisma.todo.delete({
  where: { id: 'todo-id' },
});
```

### Relations

```typescript
// Include relations
const user = await prisma.user.findUnique({
  where: { id: 'user-id' },
  include: {
    todos: true,
    files: true,
  },
});

// Select specific fields
const user = await prisma.user.findUnique({
  where: { id: 'user-id' },
  select: {
    id: true,
    name: true,
    todos: {
      select: {
        id: true,
        title: true,
      },
    },
  },
});
```

### Transactions

```typescript
// Interactive transactions
await prisma.$transaction(async (tx) => {
  const user = await tx.user.create({
    data: { email: 'user@example.com', name: 'John' },
  });

  await tx.todo.create({
    data: {
      title: 'First Todo',
      userId: user.id,
    },
  });
});

// Sequential operations
const [users, todos] = await prisma.$transaction([
  prisma.user.findMany(),
  prisma.todo.findMany(),
]);
```

### Pagination

```typescript
const page = 1;
const pageSize = 10;

const todos = await prisma.todo.findMany({
  skip: (page - 1) * pageSize,
  take: pageSize,
  orderBy: {
    createdAt: 'desc',
  },
});

const total = await prisma.todo.count();
const totalPages = Math.ceil(total / pageSize);
```

### Aggregations

```typescript
// Count
const todoCount = await prisma.todo.count({
  where: { completed: true },
});

// Aggregate
const stats = await prisma.todo.aggregate({
  _count: true,
  _max: {
    createdAt: true,
  },
});

// Group by
const userTodos = await prisma.todo.groupBy({
  by: ['userId'],
  _count: true,
});
```

## Migrations

### Creating a Migration

1. Modify your schema files in `src/prisma/schema/`
2. Run migration:
```bash
bun run db:migrate
```
3. Enter migration name when prompted
4. Prisma generates SQL and applies it

### Migration Files

Located in `src/prisma/migrations/`:

```
migrations/
├── migration_lock.toml
├── 20231013191037_init/
│   └── migration.sql
└── 20231014123456_add_todo_priority/
    └── migration.sql
```

### Rolling Back

Prisma doesn't support rollbacks directly. Options:

1. **Reset and replay**: `bun run db:reset`
2. **Manual SQL**: Write inverse migration manually
3. **Restore backup**: Use database backup

## Database Seeding

### Seed File (`src/prisma/seed.ts`)

```typescript
import { prisma } from './index';

async function main() {
  // Create admin user
  const admin = await prisma.user.upsert({
    where: { email: 'admin@example.com' },
    update: {},
    create: {
      email: 'admin@example.com',
      name: 'Admin User',
      role: 'admin',
    },
  });

  // Create sample todos
  await prisma.todo.createMany({
    data: [
      { title: 'First Todo', userId: admin.id },
      { title: 'Second Todo', userId: admin.id, completed: true },
    ],
  });

  console.log('✅ Database seeded');
}

main()
  .catch((e) => {
    console.error('❌ Seeding failed:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

### Run Seed

```bash
bun run db:reset  # Resets DB and runs seed automatically
```

## Prisma Studio

Visual database browser:

```bash
bun run db:studio
```

Opens at [http://localhost:5555](http://localhost:5555)

Features:
- View all tables
- Edit data inline
- Create/delete records
- Filter and search
- Export data

## Best Practices

### 1. Always Use Transactions for Related Operations

```typescript
// ❌ Bad: Separate operations
const user = await prisma.user.create({ data: userData });
await prisma.profile.create({ data: { userId: user.id, ...profileData } });

// ✅ Good: Single transaction
await prisma.$transaction(async (tx) => {
  const user = await tx.user.create({ data: userData });
  await tx.profile.create({ data: { userId: user.id, ...profileData } });
});
```

### 2. Use Indexes for Frequent Queries

```prisma
model Todo {
  // ...
  @@index([userId])  // For queries filtering by userId
  @@index([createdAt])  // For sorting by date
}
```

### 3. Validate Input with Zod

```typescript
import { z } from 'zod';

const createTodoSchema = z.object({
  title: z.string().min(1).max(255),
  userId: z.string(),
});

const input = createTodoSchema.parse(data);
await prisma.todo.create({ data: input });
```

### 4. Handle Errors Properly

```typescript
import { Prisma } from '@/prisma/generated/client';

try {
  await prisma.user.create({ data });
} catch (error) {
  if (error instanceof Prisma.PrismaClientKnownRequestError) {
    if (error.code === 'P2002') {
      throw new Error('Email already exists');
    }
  }
  throw error;
}
```

### 5. Use Connection Pooling in Production

```typescript
// prisma/index.ts
export const prisma = new PrismaClient({
  datasources: {
    db: {
      url: process.env.DATABASE_URL + '?connection_limit=10',
    },
  },
});
```

## Adding a New Model

### 1. Create Schema File

```prisma
// src/prisma/schema/product.prisma
model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Float
  stock       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@map("products")
}
```

### 2. Run Migration

```bash
bun run db:migrate
```

### 3. Generate Client

```bash
bun run db:generate
```

### 4. Use in Code

```typescript
import { prisma } from '@/prisma';

const product = await prisma.product.create({
  data: {
    name: 'Product Name',
    price: 29.99,
    stock: 100,
  },
});
```

## Common Error Codes

| Code | Meaning | Solution |
|------|---------|----------|
| P2002 | Unique constraint violation | Check for duplicates |
| P2025 | Record not found | Verify ID exists |
| P2003 | Foreign key constraint failed | Check relations |
| P2014 | Relation violation | Delete related records first |

## Prisma vs Raw SQL

### When to Use Prisma

- CRUD operations
- Type-safe queries
- Relations
- Migrations

### When to Use Raw SQL

```typescript
// Complex queries not supported by Prisma
const result = await prisma.$queryRaw`
  SELECT u.name, COUNT(t.id) as todo_count
  FROM users u
  LEFT JOIN todos t ON u.id = t.user_id
  GROUP BY u.id, u.name
  HAVING COUNT(t.id) > 5
`;
```

## Backup & Restore

### Manual Backup

```bash
# Using pg_dump
docker exec -e PGPASSWORD=your_password your_postgres_container \
  pg_dump -U postgres -F p my_app_db > backup.sql

# Restore
docker exec -i your_postgres_container \
  psql -U postgres my_app_db < backup.sql
```

### Automated Backup

See [Database Backup Queue](../src/lib/bullmq/examples/database-backup-queue.ts) for automated backups to MinIO.

## Resources

- [Prisma Documentation](https://www.prisma.io/docs)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Prisma Schema Reference](https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference)
- [Prisma Client API](https://www.prisma.io/docs/reference/api-reference/prisma-client-reference)

---

[← Back to Main README](../README.md)
